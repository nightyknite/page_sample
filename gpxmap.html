<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPX „Éï„Ç°„Ç§„É´ÁîüÊàê„ÉÑ„Éº„É´</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
            min-height: 600px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .map-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }

        .map-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-controls {
            display: flex;
            gap: 10px;
        }

        .map-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .map-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .map-btn.active {
            background: white;
            color: #4facfe;
        }

        #map {
            height: 500px;
            width: 100%;
        }

        .control-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .input-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        input[type="number"], input[type="datetime-local"], input[type="text"] {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        input:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #55a3ff 0%, #003d82 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(85, 163, 255, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(85, 163, 255, 0.6);
        }

        .points-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: #fafafa;
        }

        .point-item {
            padding: 12px;
            border-bottom: 1px solid #e1e5e9;
            background: white;
            margin: 3px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .point-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .point-item:last-child {
            border-bottom: none;
        }

        .point-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .point-number {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #ee5a24;
            transform: scale(1.05);
        }

        .point-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.8rem;
            color: #666;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 600;
            text-align: center;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .status.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status.success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
        }

        .status.error {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            color: white;
        }

        .icon {
            font-size: 1.1rem;
        }

        .track-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
            margin-bottom: 15px;
        }

        .info-panel h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }

        .info-panel p {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .mode-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(79, 172, 254, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .track-info {
                grid-template-columns: 1fr;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
            
            .point-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è GPX „Éï„Ç°„Ç§„É´ÁîüÊàê„ÉÑ„Éº„É´</h1>
            <p>„Éû„ÉÉ„Éó‰∏ä„Åß„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ GPS „Éá„Éº„Çø„Çí‰ΩúÊàê„Åó„ÄÅGPX „Éï„Ç°„Ç§„É´„ÇíÁîüÊàê</p>
        </div>

        <div class="main-content">
            <div class="map-section">
                <div class="map-header">
                    <span><span class="icon">üó∫Ô∏è</span> „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Éû„ÉÉ„Éó</span>
                    <div class="map-controls">
                        <button class="map-btn active" id="clickModeBtn" onclick="toggleMode('click')">
                            <span class="icon">üëÜ</span> „ÇØ„É™„ÉÉ„ÇØ„É¢„Éº„Éâ
                        </button>
                        <button class="map-btn" id="panModeBtn" onclick="toggleMode('pan')">
                            <span class="icon">‚úã</span> „Éë„É≥„É¢„Éº„Éâ
                        </button>
                        <button class="map-btn" onclick="clearMapPoints()">
                            <span class="icon">üóëÔ∏è</span> „Éû„ÉÉ„Éó„ÇØ„É™„Ç¢
                        </button>
                    </div>
                </div>
                <div class="mode-indicator" id="modeIndicator">üìç „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éù„Ç§„É≥„Éà„ÇíËøΩÂä†</div>
                <div id="map"></div>
            </div>

            <div class="control-section">
                <div class="input-section">
                    <h2><span class="icon">‚öôÔ∏è</span> „Éà„É©„ÉÉ„ÇØË®≠ÂÆö</h2>
                    <div class="track-info">
                        <div class="input-field">
                            <label for="trackName">„Éà„É©„ÉÉ„ÇØÂêç</label>
                            <input type="text" id="trackName" placeholder="‰æã: Êúù„ÅÆÊï£Ê≠©" value="GPS„Éà„É©„ÉÉ„ÇØ">
                        </div>
                        <div class="input-field">
                            <label for="trackDesc">Ë™¨Êòé</label>
                            <input type="text" id="trackDesc" placeholder="‰æã: ÂÖ¨ÂúíÂë®Ëæ∫„ÅÆ„É´„Éº„Éà">
                        </div>
                    </div>

                    <div class="info-panel">
                        <h3>üìç ‰Ωø„ÅÑÊñπ</h3>
                        <p>1. „ÇØ„É™„ÉÉ„ÇØ„É¢„Éº„Éâ„Åß„Éû„ÉÉ„Éó‰∏ä„Çí„ÇØ„É™„ÉÉ„ÇØ<br>
                        2. Ê®ôÈ´ò„Å®ÊôÇÂàª„ÇíË™øÊï¥ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ<br>
                        3. GPX„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</p>
                    </div>
                </div>

                <div class="input-section">
                    <h2><span class="icon">üìù</span> ÊúÄÊñ∞„Éù„Ç§„É≥„ÉàÁ∑®ÈõÜ</h2>
                    <div class="input-group">
                        <div class="input-row">
                            <div class="input-field">
                                <label for="currentElevation">Ê®ôÈ´ò (m)</label>
                                <input type="number" id="currentElevation" step="0.1" placeholder="10.0">
                            </div>
                            <div class="input-field">
                                <label for="currentDatetime">Êó•ÊôÇ</label>
                                <input type="datetime-local" id="currentDatetime">
                            </div>
                        </div>
                    </div>
                    <div class="controls">
                        <button class="btn btn-primary" onclick="updateLastPoint()">
                            <span class="icon">‚úèÔ∏è</span> ÊúÄÊñ∞„Éù„Ç§„É≥„ÉàÊõ¥Êñ∞
                        </button>
                    </div>
                </div>

                <div class="input-section">
                    <h2><span class="icon">üìã</span> „Éù„Ç§„É≥„Éà„É™„Çπ„Éà (<span id="pointCount">0</span>)</h2>
                    <div class="points-list" id="pointsList">
                        <div style="padding: 30px; text-align: center; color: #999;">
                            <span class="icon" style="font-size: 2rem;">üìç</span>
                            <p>„Éû„ÉÉ„Éó„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éù„Ç§„É≥„Éà„ÇíËøΩÂä†</p>
                        </div>
                    </div>
                    <div class="controls">
                        <button class="btn btn-success" onclick="generateGPX()" id="generateBtn" disabled>
                            <span class="icon">üíæ</span> GPXÁîüÊàê
                        </button>
                        <button class="btn btn-secondary" onclick="clearAllPoints()">
                            <span class="icon">üóëÔ∏è</span> ÂÖ®ÂâäÈô§
                        </button>
                    </div>
                    <div class="status" id="status"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        let map;
        let points = [];
        let pointCounter = 0;
        let markers = [];
        let polyline;
        let isClickMode = true;

        // „Éû„ÉÉ„ÉóÂàùÊúüÂåñ
        function initMap() {
            map = L.map('map').setView([35.681236, 139.767125], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // „Éû„ÉÉ„Éó„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            map.on('click', function(e) {
                if (isClickMode) {
                    addPointFromMap(e.latlng.lat, e.latlng.lng);
                }
            });

            setCurrentTime();
        }

        // „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function toggleMode(mode) {
            isClickMode = (mode === 'click');
            
            document.getElementById('clickModeBtn').classList.toggle('active', isClickMode);
            document.getElementById('panModeBtn').classList.toggle('active', !isClickMode);
            
            const indicator = document.getElementById('modeIndicator');
            if (isClickMode) {
                indicator.textContent = 'üìç „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éù„Ç§„É≥„Éà„ÇíËøΩÂä†';
                map.dragging.enable();
            } else {
                indicator.textContent = '‚úã „Éë„É≥„É¢„Éº„ÉâÔºàÂú∞Âõ≥ÁßªÂãïÔºâ';
                map.dragging.enable();
            }
        }

        // „Éû„ÉÉ„Éó„Åã„Çâ„Éù„Ç§„É≥„ÉàËøΩÂä†
        function addPointFromMap(lat, lng) {
            const elevation = parseFloat(document.getElementById('currentElevation').value) || 0;
            const datetime = document.getElementById('currentDatetime').value;

            if (!datetime) {
                showStatus('Êó•ÊôÇ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            const point = {
                id: ++pointCounter,
                latitude: lat,
                longitude: lng,
                elevation: elevation,
                datetime: datetime
            };

            points.push(point);
            addMarkerToMap(point, points.length);
            updatePointsList();
            updateGenerateButton();
            updatePolyline();
            showStatus('„Éù„Ç§„É≥„Éà„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü', 'success');

            // Ê¨°„ÅÆ„Éù„Ç§„É≥„Éà„ÅÆÊôÇÂàª„Çí1ÂàÜÂæå„Å´Ëá™ÂãïË®≠ÂÆö
            const nextTime = new Date(datetime);
            nextTime.setMinutes(nextTime.getMinutes() + 1);
            const nextLocalDateTime = new Date(nextTime.getTime() - nextTime.getTimezoneOffset() * 60000);
            document.getElementById('currentDatetime').value = nextLocalDateTime.toISOString().slice(0, 16);
        }

        // „Éû„ÉÉ„Éó„Å´„Éû„Éº„Ç´„ÉºËøΩÂä†
        function addMarkerToMap(point, index) {
            const marker = L.marker([point.latitude, point.longitude])
                .addTo(map)
                .bindPopup(`
                    <div style="font-size: 0.9rem;">
                        <strong>„Éù„Ç§„É≥„Éà ${index}</strong><br>
                        Á∑ØÂ∫¶: ${point.latitude.toFixed(6)}<br>
                        ÁµåÂ∫¶: ${point.longitude.toFixed(6)}<br>
                        Ê®ôÈ´ò: ${point.elevation.toFixed(1)}m<br>
                        ÊôÇÂàª: ${formatDateTime(point.datetime)}
                    </div>
                `);
            
            markers.push({id: point.id, marker: marker});
        }

        // „Éù„É™„É©„Ç§„É≥Êõ¥Êñ∞
        function updatePolyline() {
            if (polyline) {
                map.removeLayer(polyline);
            }
            
            if (points.length > 1) {
                const latLngs = points.map(point => [point.latitude, point.longitude]);
                polyline = L.polyline(latLngs, {
                    color: '#4facfe',
                    weight: 3,
                    opacity: 0.8
                }).addTo(map);
            }
        }

        // „Éû„ÉÉ„Éó„ÅÆ„Éù„Ç§„É≥„Éà„Çí„ÇØ„É™„Ç¢
        function clearMapPoints() {
            markers.forEach(markerObj => {
                map.removeLayer(markerObj.marker);
            });
            markers = [];
            
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }
        }

        // ÊúÄÊñ∞„Éù„Ç§„É≥„ÉàÊõ¥Êñ∞
        function updateLastPoint() {
            if (points.length === 0) {
                showStatus('Êõ¥Êñ∞„Åô„Çã„Éù„Ç§„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }

            const elevation = parseFloat(document.getElementById('currentElevation').value) || 0;
            const datetime = document.getElementById('currentDatetime').value;

            if (!datetime) {
                showStatus('Êó•ÊôÇ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            const lastPoint = points[points.length - 1];
            lastPoint.elevation = elevation;
            lastPoint.datetime = datetime;

            // „Éû„Éº„Ç´„Éº„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÊõ¥Êñ∞
            const lastMarker = markers.find(m => m.id === lastPoint.id);
            if (lastMarker) {
                lastMarker.marker.setPopupContent(`
                    <div style="font-size: 0.9rem;">
                        <strong>„Éù„Ç§„É≥„Éà ${points.length}</strong><br>
                        Á∑ØÂ∫¶: ${lastPoint.latitude.toFixed(6)}<br>
                        ÁµåÂ∫¶: ${lastPoint.longitude.toFixed(6)}<br>
                        Ê®ôÈ´ò: ${lastPoint.elevation.toFixed(1)}m<br>
                        ÊôÇÂàª: ${formatDateTime(lastPoint.datetime)}
                    </div>
                `);
            }

            updatePointsList();
            showStatus('„Éù„Ç§„É≥„Éà„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü', 'success');

            // Ê¨°„ÅÆ„Éù„Ç§„É≥„Éà„ÅÆÊôÇÂàª„Çí1ÂàÜÂæå„Å´Ëá™ÂãïË®≠ÂÆö
            const nextTime = new Date(datetime);
            nextTime.setMinutes(nextTime.getMinutes() + 1);
            const nextLocalDateTime = new Date(nextTime.getTime() - nextTime.getTimezoneOffset() * 60000);
            document.getElementById('currentDatetime').value = nextLocalDateTime.toISOString().slice(0, 16);
        }

        // „Éù„Ç§„É≥„ÉàÂâäÈô§
        function deletePoint(id) {
            const pointIndex = points.findIndex(point => point.id === id);
            if (pointIndex === -1) return;

            points.splice(pointIndex, 1);
            
            // „Éû„Éº„Ç´„ÉºÂâäÈô§
            const markerIndex = markers.findIndex(m => m.id === id);
            if (markerIndex !== -1) {
                map.removeLayer(markers[markerIndex].marker);
                markers.splice(markerIndex, 1);
            }

            updatePointsList();
            updateGenerateButton();
            updatePolyline();
            showStatus('„Éù„Ç§„É≥„Éà„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü', 'success');
        }

        // ÂÖ®„Éù„Ç§„É≥„ÉàÂâäÈô§
        function clearAllPoints() {
            if (points.length === 0) return;
            
            if (confirm('„Åô„Åπ„Å¶„ÅÆ„Éù„Ç§„É≥„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                points = [];
                clearMapPoints();
                updatePointsList();
                updateGenerateButton();
                showStatus('„Åô„Åπ„Å¶„ÅÆ„Éù„Ç§„É≥„Éà„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü', 'success');
            }
        }

        // ÁèæÂú®ÊôÇÂàªË®≠ÂÆö
        function setCurrentTime() {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
            document.getElementById('currentDatetime').value = localDateTime.toISOString().slice(0, 16);
        }

        // „Éù„Ç§„É≥„Éà„É™„Çπ„ÉàÊõ¥Êñ∞
        function updatePointsList() {
            const pointsList = document.getElementById('pointsList');
            const pointCount = document.getElementById('pointCount');
            
            pointCount.textContent = points.length;

            if (points.length === 0) {
                pointsList.innerHTML = `
                    <div style="padding: 30px; text-align: center; color: #999;">
                        <span class="icon" style="font-size: 2rem;">üìç</span>
                        <p>„Éû„ÉÉ„Éó„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éù„Ç§„É≥„Éà„ÇíËøΩÂä†</p>
                    </div>
                `;
                return;
            }

            pointsList.innerHTML = points.map((point, index) => `
                <div class="point-item">
                    <div class="point-header">
                        <span class="point-number">„Éù„Ç§„É≥„Éà ${index + 1}</span>
                        <button class="delete-btn" onclick="deletePoint(${point.id})">ÂâäÈô§</button>
                    </div>
                    <div class="point-details">
                        <div><strong>Á∑ØÂ∫¶:</strong> ${point.latitude.toFixed(6)}</div>
                        <div><strong>ÁµåÂ∫¶:</strong> ${point.longitude.toFixed(6)}</div>
                        <div><strong>Ê®ôÈ´ò:</strong> ${point.elevation.toFixed(1)}m</div>
                        <div><strong>Êó•ÊôÇ:</strong> ${formatDateTime(point.datetime)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Êó•ÊôÇ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatDateTime(datetime) {
            const date = new Date(datetime);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ÁîüÊàê„Éú„Çø„É≥Êõ¥Êñ∞
        function updateGenerateButton() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = points.length === 0;
        }

        // GPXÁîüÊàê
        function generateGPX() {
            if (points.length === 0) {
                showStatus('„Éù„Ç§„É≥„Éà„ÅåËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            const trackName = document.getElementById('trackName').value || 'GPS„Éà„É©„ÉÉ„ÇØ';
            const trackDesc = document.getElementById('trackDesc').value || '';

            // ÊôÇÈñìÈ†Ü„Å´„ÇΩ„Éº„Éà
            const sortedPoints = [...points].sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

            const gpxContent = generateGPXContent(trackName, trackDesc, sortedPoints);
            downloadGPX(gpxContent, trackName);
            showStatus(`GPX„Éï„Ç°„Ç§„É´ "${trackName}.gpx" „Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü`, 'success');
        }

        // GPX„Ç≥„É≥„ÉÜ„É≥„ÉÑÁîüÊàê
        function generateGPXContent(trackName, trackDesc, points) {
            const header = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="GPX Generator Tool" xmlns="http://www.topografix.com/GPX/1/1">
    <metadata>
        <name>${escapeXml(trackName)}</name>
        <desc>${escapeXml(trackDesc)}</desc>
        <time>${new Date().toISOString()}</time>
    </metadata>
    <trk>
        <name>${escapeXml(trackName)}</name>
        <desc>${escapeXml(trackDesc)}</desc>
        <trkseg>`;

            const trackPoints = points.map(point => {
                const isoDateTime = new Date(point.datetime).toISOString();
                return `            <trkpt lat="${point.latitude}" lon="${point.longitude}">
                <ele>${point.elevation}</ele>
                <time>${isoDateTime}</time>
            </trkpt>`;
            }).join('\n');

            const footer = `
        </trkseg>
    </trk>
</gpx>`;

            return header + '\n' + trackPoints + footer;
        }

        // XML „Ç®„Çπ„Ç±„Éº„Éó
        function escapeXml(text) {
            return text.replace(/[<>&'"]/g, function(char) {
                switch (char) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return char;
                }
            });
        }

        // „Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadGPX(content, filename) {
            const blob = new Blob([content], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.gpx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.add('show');

            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html>
